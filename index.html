<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NewShire AMI Verification Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700;800;900&family=Source+Code+Pro:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Source Sans 3', 'Segoe UI', sans-serif; background: #1C3740; }
  #root { min-height: 100vh; }
  .hist-row:hover { background: rgba(205,160,75,0.06) !important; cursor: pointer; }
</style>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script crossorigin src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module">
const { useState, useEffect, useCallback, useRef } = React;

const CONFIG = {
  clientId: "32e75ffa-747a-4cf0-8209-6a19150c4547",
  tenantId: "33575d04-ca7b-4396-8011-9eaea4030b46",
  siteId: "vanrockre.sharepoint.com,a02c1cd8-9f1f-4827-8286-7b6b7ce74232,01202419-6625-4499-b0d5-8ceb1cffdba3",
  listName: "AMI Verification Log",
  configListName: "AMI Calculator Config",
  isConfigured: true,
  // Seed admins — once users are saved to SharePoint, this is only a fallback
  seedAdmins: ["bturner@newshirepm.com","cmunson@newshirepm.com","jwhite@vanrockre.com"],
};
const GRAPH = "https://graph.microsoft.com/v1.0";

// ROLES: manager=view calc+history+reprint, approver=submit verifications, admin=override+edit config+manage users
const ROLES = { ADMIN:"admin", APPROVER:"approver", MANAGER:"manager" };
const ROLE_LABELS = { admin:"Admin", approver:"Approver", manager:"Manager" };

const DEFAULT_USERS = [
  { email:"bturner@newshirepm.com", name:"Brandy Turner", role:"admin" },
  { email:"cmunson@newshirepm.com", name:"C. Munson", role:"admin" },
  { email:"jwhite@vanrockre.com", name:"J. White", role:"admin" },
];

const DEFAULT_COUNTIES = {
  "Spartanburg County, SC": {
    label:"FY 2025 HUD Income Limits — Spartanburg County, SC", medianIncome:82400,
    tiers:[0.3,0.5,0.6,0.8,1.0], personCounts:[1,2,3,4,5,6,7,8],
    limits:[
      [17300,19750,22200,24650,26650,28600,30600,32550],
      [28750,32850,36950,41050,44350,47650,50950,54200],
      [34500,39420,44340,49260,53220,57180,61140,65040],
      [46000,52600,59150,65700,71000,76250,81500,86750],
      [57700,65950,74200,82400,89000,95600,102200,108800],
    ],
  },
};
const DEFAULT_PROPERTIES = [
  {name:"701 East Main Condos",county:"Spartanburg County, SC",units:[
    {bedrooms:0,ami:0.6,maxRent:860,marketRent:860,count:5},{bedrooms:0,ami:0.8,maxRent:1150,marketRent:960,count:6},{bedrooms:1,ami:0.6,maxRent:920,marketRent:920,count:1}]},
  {name:"City View",county:"Spartanburg County, SC",units:[
    {bedrooms:1,ami:0.6,maxRent:920,marketRent:895,count:7},{bedrooms:1,ami:0.8,maxRent:1230,marketRent:955,count:11},{bedrooms:2,ami:0.6,maxRent:1105,marketRent:1095,count:7},{bedrooms:2,ami:0.8,maxRent:1475,marketRent:1195,count:3}]},
  {name:"Fusion Pointe",county:"Spartanburg County, SC",units:[
    {bedrooms:1,ami:0.6,maxRent:920,marketRent:600,count:14},{bedrooms:3,ami:0.6,maxRent:1280,marketRent:1280,count:9},{bedrooms:3,ami:0.8,maxRent:1705,marketRent:1285,count:15},{bedrooms:4,ami:0.6,maxRent:1430,marketRent:1375,count:11},{bedrooms:4,ami:0.8,maxRent:1905,marketRent:1375,count:13}]},
  {name:"Liberty Square",county:"Spartanburg County, SC",units:[
    {bedrooms:1,ami:0.5,maxRent:770,marketRent:770,count:4},{bedrooms:2,ami:0.5,maxRent:900,marketRent:900,count:4},{bedrooms:2,ami:0.8,maxRent:1400,marketRent:1064,count:19},{bedrooms:3,ami:0.8,maxRent:1608,marketRent:1375,count:3}]},
  {name:"Townes at Converse",county:"Spartanburg County, SC",units:[
    {bedrooms:3,ami:0.5,maxRent:1067,marketRent:1067,count:16},{bedrooms:3,ami:0.8,maxRent:1708,marketRent:1708,count:43}]},
];

const PAY_FREQ=[{label:"Weekly",m:52},{label:"BiWeekly",m:26},{label:"Semi Monthly",m:24},{label:"Monthly",m:12}];
const OTH_FREQ=[...PAY_FREQ,{label:"Bi Monthly",m:6},{label:"Quarterly",m:4},{label:"Semi Annually",m:2},{label:"Annually",m:1}];
const OTH_TYPES=["Child Support","SSI/SSDI","Pension","VA Benefits","Unemployment","Self Employment","Interest/Dividends","W2 Verified Employment","Other"];

const B={teal900:"#1C3740",teal800:"#213F4A",teal700:"#28434C",teal600:"#2F5260",teal500:"#3A6577",teal400:"#4A7E91",teal300:"#6FA0B0",teal200:"#A3C5CF",teal100:"#D6E7EC",teal50:"#EDF4F7",gold700:"#9E7B2F",gold600:"#B8922E",gold500:"#CDA04B",gold400:"#D4AF61",gold300:"#E0C680",gold200:"#EDDAAC",gold100:"#F8F0DB",gold50:"#FFFBF0",white:"#F1F3F2",offWhite:"#F7F8F7",gray100:"#E8EAEA",gray200:"#D0D4D4",gray300:"#A8B0B0",gray400:"#7A8585",gray500:"#5A6666",gray600:"#3E4A4A",dark:"#1A2A30",ok:"#3DA06B",okBg:"rgba(61,160,107,0.08)",okBr:"rgba(61,160,107,0.3)",no:"#D35B4B",noBg:"rgba(211,91,75,0.08)",noBr:"rgba(211,91,75,0.3)",wBg:"rgba(205,160,75,0.08)",wBr:"rgba(205,160,75,0.3)",ov:"#6A8EC8",ovBg:"rgba(100,140,200,0.08)",ovBr:"rgba(100,140,200,0.3)"};
const fb="'Source Sans 3','Segoe UI',sans-serif", fm="'Source Code Pro','Fira Code',monospace";

// CALC ENGINE
function anchorP(br){return br===0?1:Math.ceil(br*1.5)}
function effP(br,occ){return Math.max(occ||anchorP(br),anchorP(br))}
function getLimit(tier,persons,lim){const ti=lim.tiers.indexOf(tier),pi=lim.personCounts.indexOf(persons);return ti===-1||pi===-1?null:lim.limits[ti][pi]}
function calcPS(stubs,freq){const v=stubs.filter(s=>s!==""&&!isNaN(+s));if(!v.length)return 0;const f=PAY_FREQ.find(x=>x.label===freq);return(v.reduce((a,b)=>a+ +b,0)/v.length)*(f?f.m:0)}
function calcOL(hr,hpw,sal){if(sal&&+sal>0)return+sal;return hr&&hpw?+hr*+hpw*52:0}
function calcBK(deps){const v=deps.filter(d=>d!==""&&!isNaN(+d));return v.length?(v.reduce((a,b)=>a+ +b,0)/v.length)*12:0}
function calcOth(items){return items.reduce((t,i)=>{if(!i.amount||!i.frequency)return t;const f=OTH_FREQ.find(x=>x.label===i.frequency);return t+ +i.amount*(f?f.m:0)},0)}
function verify({tier,br,occ,income,rent,lim}){
  const eff=effP(br,occ),limit=getLimit(tier,eff,lim);
  if(!limit)return{result:"ERROR",reason:"Limit not found",variance:0,limit:0,eff,anchor:anchorP(br),minMo:0,mo:0,tier};
  const minMo=rent*2.5,mo=income/12,anchor=anchorP(br);
  if(income>limit)return{result:"DENIED",reason:"Income Exceeds AMI Limit",variance:income-limit,limit,eff,anchor,minMo,mo,tier};
  if(mo<minMo)return{result:"DENIED",reason:"Below Minimum Income (2.5x Rent)",variance:(minMo-mo)*12,limit,eff,anchor,minMo,mo,tier};
  return{result:"APPROVED",reason:null,variance:0,limit,eff,anchor,minMo,mo,tier};
}

// MSAL
function useMsal(){
  const[state,setState]=useState({status:"idle",user:null,error:null});
  const ref=useRef(null);
  const getToken=useCallback(async()=>{
    if(!CONFIG.isConfigured)return null;
    try{
      if(!window.msal){console.error("MSAL not loaded");return null}
      if(!ref.current){ref.current=new window.msal.PublicClientApplication({auth:{clientId:CONFIG.clientId,authority:`https://login.microsoftonline.com/${CONFIG.tenantId}`,redirectUri:window.location.origin},cache:{cacheLocation:"sessionStorage"}});await ref.current.initialize()}
      const accts=ref.current.getAllAccounts(),scopes=["Sites.ReadWrite.All"];
      if(accts.length){try{const r=await ref.current.acquireTokenSilent({scopes,account:accts[0]});setState({status:"ok",user:accts[0],error:null});return r.accessToken}catch{}}
      const r=await ref.current.acquireTokenPopup({scopes});setState({status:"ok",user:r.account,error:null});return r.accessToken;
    }catch(e){console.error("Auth:",e);setState({status:"error",user:null,error:e.message});return null}
  },[]);
  return{...state,getToken};
}

// SHAREPOINT API
async function listId(tok,name){const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists?$filter=displayName eq '${name}'`,{headers:{Authorization:`Bearer ${tok}`}});const d=await r.json();return d.value?.[0]?.id||null}
async function spWrite(tok,rec){const lid=await listId(tok,CONFIG.listName);if(!lid)throw new Error("List not found");const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items`,{method:"POST",headers:{Authorization:`Bearer ${tok}`,"Content-Type":"application/json"},body:JSON.stringify({fields:rec})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Error ${r.status}`)}return r.json()}
async function spUpdate(tok,itemId,fields){const lid=await listId(tok,CONFIG.listName);if(!lid)throw new Error("List not found");const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items/${itemId}`,{method:"PATCH",headers:{Authorization:`Bearer ${tok}`,"Content-Type":"application/json"},body:JSON.stringify({fields})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Error ${r.status}`)}return r.json()}
async function spHistory(tok,n=100){const lid=await listId(tok,CONFIG.listName);if(!lid)return[];const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items?$expand=fields&$top=${n}&$orderby=fields/DateCompleted desc`,{headers:{Authorization:`Bearer ${tok}`}});if(!r.ok)return[];const d=await r.json();return(d.value||[]).map(i=>({...i.fields,_itemId:i.id}))}
async function cfgLoad(tok){const lid=await listId(tok,CONFIG.configListName);if(!lid)return null;const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items?$expand=fields&$top=10&$orderby=fields/Modified desc`,{headers:{Authorization:`Bearer ${tok}`}});if(!r.ok)return null;const d=await r.json();if(!d.value?.length)return null;const f=d.value[0].fields;try{const counties=JSON.parse(f.IncomeLimitsJSON),properties=JSON.parse(f.PropertiesJSON);let users=null;try{users=JSON.parse(f.ModifiedByName.includes("[")?f.ModifiedByName:"{}")}catch{}if(!users&&f.Title?.startsWith("Config")){/* users stored in a separate field or within IncomeLimitsJSON */}return{itemId:d.value[0].id,counties,properties,users,lastModified:f.Modified}}catch{return null}}
async function cfgSave(tok,counties,properties,users,modBy){const lid=await listId(tok,CONFIG.configListName);if(!lid)throw new Error("Config list not found");const fields={Title:`Config ${new Date().toISOString().slice(0,10)}`,IncomeLimitsJSON:JSON.stringify({counties,users}),PropertiesJSON:JSON.stringify(properties),ModifiedByName:modBy};const existing=await cfgLoad(tok);if(existing?.itemId){const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items/${existing.itemId}`,{method:"PATCH",headers:{Authorization:`Bearer ${tok}`,"Content-Type":"application/json"},body:JSON.stringify({fields})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Error ${r.status}`)}return}const r=await fetch(`${GRAPH}/sites/${CONFIG.siteId}/lists/${lid}/items`,{method:"POST",headers:{Authorization:`Bearer ${tok}`,"Content-Type":"application/json"},body:JSON.stringify({fields})});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e?.error?.message||`Error ${r.status}`)}}

// ============================================================
// UI COMPONENTS
// ============================================================
const iCss={background:B.teal900,border:`1px solid ${B.teal600}`,borderRadius:"4px",color:B.white,padding:"7px 9px",fontSize:"12.5px",outline:"none",width:"100%",boxSizing:"border-box",transition:"border-color 0.2s",fontFamily:fm};
const lCss={display:"block",fontSize:"10px",fontWeight:700,color:B.teal300,marginBottom:"3px",textTransform:"uppercase",letterSpacing:"0.6px",fontFamily:fb};
const sCss={fontSize:"11px",fontWeight:800,color:B.gold500,textTransform:"uppercase",letterSpacing:"1.2px",marginBottom:"10px",fontFamily:fb,borderBottom:`1px solid ${B.teal600}`,paddingBottom:"7px"};

function F({label,children,style}){return<div style={{marginBottom:"8px",...style}}><label style={lCss}>{label}</label>{children}</div>}
function I({value,onChange,placeholder,type="text",style,disabled}){return<input type={type} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} disabled={disabled} style={{...iCss,opacity:disabled?0.5:1,...style}} onFocus={e=>{e.target.style.borderColor=B.gold500}} onBlur={e=>{e.target.style.borderColor=B.teal600}}/>}
function Sel({value,onChange,options,placeholder,style}){return<select value={value} onChange={e=>onChange(e.target.value)} style={{...iCss,cursor:"pointer",...style}}>{placeholder&&<option value="">{placeholder}</option>}{options.map(o=><option key={typeof o==="string"?o:o.value} value={typeof o==="string"?o:o.value}>{typeof o==="string"?o:o.label}</option>)}</select>}
function Card({children,style}){return<div style={{background:B.teal800,border:`1px solid ${B.teal600}`,borderRadius:"6px",padding:"14px",...style}}>{children}</div>}
function Mon({amount,style}){if(amount==null||isNaN(amount))return<span style={style}>—</span>;return<span style={style}>${Number(amount).toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})}</span>}
function Btn({children,onClick,v="primary",style,disabled}){
  const S={primary:{background:B.gold500,color:B.teal900,border:"none",fontWeight:800},secondary:{background:"transparent",color:B.teal300,border:`1px solid ${B.teal600}`},success:{background:B.ok,color:"#fff",border:"none"},danger:{background:B.noBg,color:B.no,border:`1px solid ${B.noBr}`},small:{background:`${B.gold500}18`,color:B.gold500,border:`1px solid ${B.gold500}44`},override:{background:B.ovBg,color:B.ov,border:`1px solid ${B.ovBr}`}};
  return<button onClick={onClick} disabled={disabled} style={{...S[v],borderRadius:"4px",padding:"7px 14px",fontSize:"11px",fontWeight:700,cursor:disabled?"not-allowed":"pointer",fontFamily:fb,opacity:disabled?0.5:1,transition:"all 0.15s",letterSpacing:"0.3px",...style}}>{children}</button>;
}
function ResultBadge({result,reason,variance,tier,overrideStatus,overrideBy,overrideNotes}){
  const ok=result==="APPROVED",ovr=overrideStatus==="OVERRIDE_APPROVED";
  const bg=ovr?B.ovBg:ok?B.okBg:B.noBg,br=ovr?B.ovBr:ok?B.okBr:B.noBr,clr=ovr?B.ov:ok?B.ok:B.no;
  return(
    <div style={{background:bg,border:`1px solid ${br}`,borderRadius:"6px",padding:"10px 14px",marginBottom:"7px"}}>
      <div style={{display:"flex",alignItems:"center",gap:"7px",marginBottom:(reason&&!ovr)||ovr?"4px":0}}>
        <span style={{fontSize:"15px"}}>{ovr?"⚖":ok?"✓":"✗"}</span>
        <span style={{fontSize:"14px",fontWeight:800,color:clr,fontFamily:fb}}>{ovr?"OVERRIDE APPROVED":result} at {(tier*100).toFixed(0)}% AMI</span>
      </div>
      {reason&&!ovr&&<div style={{fontSize:"11px",color:B.gray300,marginLeft:"22px",fontFamily:fb}}>{reason}{variance>0&&<span style={{color:B.no,fontWeight:700}}> — Variance: <Mon amount={variance}/>{reason.includes("Exceeds")?" over limit":" annual shortfall"}</span>}</div>}
      {ovr&&<div style={{fontSize:"11px",color:B.gray300,marginLeft:"22px",fontFamily:fb}}>Override by: <b>{overrideBy}</b> — {overrideNotes}</div>}
    </div>
  );
}

// INCOME SECTIONS
function PaystubSec({idx,data,onChange}){
  const stubs=data.paystubs||["","","",""],freq=data.paystubFrequency||"",annual=calcPS(stubs,freq);
  return(<Card style={{marginBottom:"8px"}}><div style={sCss}>Paystubs — Applicant {idx+1}{data.name&&<span style={{color:B.white,textTransform:"none",fontWeight:400,marginLeft:"6px",fontSize:"11px"}}>({data.name})</span>}</div>
    <F label="Applicant Name"><I value={data.name||""} onChange={v=>onChange({...data,name:v})} placeholder="Full name"/></F>
    <F label="Pay Frequency"><Sel value={freq} onChange={v=>onChange({...data,paystubFrequency:v})} options={PAY_FREQ.map(f=>f.label)} placeholder="Select frequency"/></F>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:"5px"}}>{stubs.map((s,i)=><F key={i} label={`Stub ${i+1}`}><I type="number" value={s} onChange={v=>{const n=[...stubs];n[i]=v;onChange({...data,paystubs:n})}} placeholder="0.00"/></F>)}</div>
    <div style={{textAlign:"right",fontSize:"11px",color:B.teal300,fontFamily:fb}}>Annualized: <Mon amount={annual} style={{color:B.gold400,fontWeight:700}}/></div></Card>);
}
function OfferSec({idx,data,onChange}){
  const annual=calcOL(data.hourly,data.hoursPerWeek,data.salary);
  return(<Card style={{marginBottom:"8px"}}><div style={sCss}>Offer Letter — Applicant {idx+1}{data.name&&<span style={{color:B.white,textTransform:"none",fontWeight:400,marginLeft:"6px",fontSize:"11px"}}>({data.name})</span>}</div>
    <F label="Applicant Name"><I value={data.name||""} onChange={v=>onChange({...data,name:v})} placeholder="Full name"/></F>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"6px"}}>
      <F label="Hourly Pay"><I type="number" value={data.hourly||""} onChange={v=>onChange({...data,hourly:v})} placeholder="0.00"/></F>
      <F label="Hours/Week"><I type="number" value={data.hoursPerWeek||""} onChange={v=>onChange({...data,hoursPerWeek:v})} placeholder="40"/></F>
      <F label="Annual Salary (if salaried)"><I type="number" value={data.salary||""} onChange={v=>onChange({...data,salary:v})} placeholder="0"/></F>
    </div>
    <div style={{textAlign:"right",fontSize:"11px",color:B.teal300,fontFamily:fb}}>Annualized: <Mon amount={annual} style={{color:B.gold400,fontWeight:700}}/></div></Card>);
}
function BankSec({idx,data,onChange}){
  const deps=data.deposits||["","",""],annual=calcBK(deps);
  return(<Card style={{marginBottom:"8px"}}><div style={sCss}>Bank Statements — Applicant {idx+1}{data.name&&<span style={{color:B.white,textTransform:"none",fontWeight:400,marginLeft:"6px",fontSize:"11px"}}>({data.name})</span>}</div>
    <F label="Applicant Name"><I value={data.name||""} onChange={v=>onChange({...data,name:v})} placeholder="Full name"/></F>
    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"6px"}}>{deps.map((d,i)=><F key={i} label={`Statement ${i+1} Deposits`}><I type="number" value={d} onChange={v=>{const n=[...deps];n[i]=v;onChange({...data,deposits:n})}} placeholder="0.00"/></F>)}</div>
    <div style={{textAlign:"right",fontSize:"11px",color:B.teal300,fontFamily:fb}}>Annualized: <Mon amount={annual} style={{color:B.gold400,fontWeight:700}}/></div></Card>);
}
function OtherSec({items,onChange}){
  const annual=calcOth(items);
  return(<Card style={{marginBottom:"8px"}}>
    <div style={{...sCss,display:"flex",justifyContent:"space-between",alignItems:"center"}}><span>Other Income Sources</span><Btn v="small" onClick={()=>onChange([...items,{type:"",receiver:"",amount:"",frequency:"",notes:""}])} style={{padding:"2px 8px",fontSize:"10px"}}>+ Add</Btn></div>
    {items.map((item,i)=>(<div key={i} style={{display:"grid",gridTemplateColumns:"130px 1fr 90px 110px 1fr 24px",gap:"5px",alignItems:"end",marginBottom:"5px"}}>
      <F label={i===0?"Type":""}><Sel value={item.type} onChange={v=>{const n=[...items];n[i]={...n[i],type:v};onChange(n)}} options={OTH_TYPES} placeholder="—"/></F>
      <F label={i===0?"Receiver":""}><I value={item.receiver} onChange={v=>{const n=[...items];n[i]={...n[i],receiver:v};onChange(n)}} placeholder="Name"/></F>
      <F label={i===0?"Amount":""}><I type="number" value={item.amount} onChange={v=>{const n=[...items];n[i]={...n[i],amount:v};onChange(n)}} placeholder="0"/></F>
      <F label={i===0?"Frequency":""}><Sel value={item.frequency} onChange={v=>{const n=[...items];n[i]={...n[i],frequency:v};onChange(n)}} options={OTH_FREQ.map(f=>f.label)} placeholder="—"/></F>
      <F label={i===0?"Notes":""}><I value={item.notes} onChange={v=>{const n=[...items];n[i]={...n[i],notes:v};onChange(n)}} placeholder="Optional"/></F>
      <button onClick={()=>onChange(items.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:"none",color:B.no,cursor:"pointer",fontSize:"15px",padding:"7px 2px",marginBottom:"8px"}}>×</button>
    </div>))}
    <div style={{textAlign:"right",fontSize:"11px",color:B.teal300,fontFamily:fb}}>Annualized: <Mon amount={annual} style={{color:B.gold400,fontWeight:700}}/></div></Card>);
}

// HISTORY PANEL — clickable rows
function HistoryPanel({history,loading,onSelect,userRole}){
  if(loading)return<Card><div style={{textAlign:"center",color:B.teal300,padding:"20px",fontSize:"12px"}}>Loading history...</div></Card>;
  if(!history?.length)return<Card><div style={{textAlign:"center",color:B.gray400,padding:"20px",fontSize:"12px"}}>No verifications submitted yet.</div></Card>;
  return(
    <Card style={{maxHeight:"500px",overflowY:"auto"}}>
      <div style={sCss}>Recent Verifications ({history.length}){userRole!=="manager"&&<span style={{fontWeight:400,textTransform:"none",fontSize:"10px",color:B.teal300,marginLeft:"8px"}}>Click a row to reload into calculator</span>}</div>
      <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}>
        <thead><tr style={{borderBottom:`1px solid ${B.teal600}`}}>
          {["Date","Reviewer","Property","Unit","Applicant","BR","AMI","Income","Limit","Result"].map(h=><th key={h} style={{padding:"5px 4px",textAlign:"left",color:B.teal300,fontWeight:700,fontSize:"9px",textTransform:"uppercase",letterSpacing:"0.5px"}}>{h}</th>)}
        </tr></thead>
        <tbody>{history.map((r,i)=>{
          const isOk=r.Result==="Approved",isOvr=r.Result?.includes("Override"),isAltOk=r.AltResult==="Approved";
          const badge=isOvr?"OVERRIDE":isOk?"OK":isAltOk?"ALT OK":"DENIED";
          const bClr=isOvr?B.ov:isOk?B.ok:isAltOk?B.gold500:B.no;
          const bBg=isOvr?B.ovBg:isOk?B.okBg:isAltOk?B.wBg:B.noBg;
          const bBr=isOvr?B.ovBr:isOk?B.okBr:isAltOk?B.wBr:B.noBr;
          return(<tr key={i} className="hist-row" onClick={()=>onSelect(r)} style={{borderBottom:`1px solid ${B.teal600}22`,background:i%2===0?"transparent":`${B.teal700}66`}}>
            <td style={{padding:"5px 4px",color:B.teal300,fontFamily:fm,fontSize:"10px"}}>{r.DateCompleted?new Date(r.DateCompleted).toLocaleDateString("en-US",{month:"short",day:"numeric"}):"—"}</td>
            <td style={{padding:"5px 4px",color:B.white}}>{r.Reviewer||"—"}</td>
            <td style={{padding:"5px 4px",color:B.white}}>{r.Property||"—"}</td>
            <td style={{padding:"5px 4px",color:B.teal300,fontFamily:fm}}>{r.UnitAddress||"—"}</td>
            <td style={{padding:"5px 4px",color:B.white}}>{r.ApplicantName||"—"}</td>
            <td style={{padding:"5px 4px",color:B.teal300,textAlign:"center"}}>{r.Bedrooms??"—"}</td>
            <td style={{padding:"5px 4px",color:B.teal300,textAlign:"center"}}>{r.AMITier?`${(+r.AMITier*100).toFixed(0)}%`:"—"}</td>
            <td style={{padding:"5px 4px",fontFamily:fm,textAlign:"right",color:B.white}}>{r.TotalIncome?`$${(+r.TotalIncome).toLocaleString()}`:"—"}</td>
            <td style={{padding:"5px 4px",fontFamily:fm,textAlign:"right",color:B.teal300}}>{r.IncomeLimit?`$${(+r.IncomeLimit).toLocaleString()}`:"—"}</td>
            <td style={{padding:"5px 4px"}}><span style={{display:"inline-block",padding:"1px 6px",borderRadius:"3px",fontSize:"10px",fontWeight:700,background:bBg,color:bClr,border:`1px solid ${bBr}`}}>{badge}</span></td>
          </tr>);
        })}</tbody>
      </table>
    </Card>
  );
}

// ============================================================
// ADMIN PANEL — Tabs: Income Limits (per county), Properties, Users
// ============================================================
function AdminPanel({counties,properties,users,onSave,saving,lastSaved,isAdmin}){
  const[aTab,setATab]=useState("limits");
  const[cEdit,setCEdit]=useState(JSON.parse(JSON.stringify(counties)));
  const[pEdit,setPEdit]=useState(JSON.parse(JSON.stringify(properties)));
  const[uEdit,setUEdit]=useState(JSON.parse(JSON.stringify(users)));
  const[dirty,setDirty]=useState(false);
  const[selCounty,setSelCounty]=useState(Object.keys(counties)[0]||"");
  const[newCounty,setNewCounty]=useState("");
  const[newUserEmail,setNewUserEmail]=useState("");
  const[newUserName,setNewUserName]=useState("");
  const[newUserRole,setNewUserRole]=useState("manager");

  useEffect(()=>{setCEdit(JSON.parse(JSON.stringify(counties)))},[counties]);
  useEffect(()=>{setPEdit(JSON.parse(JSON.stringify(properties)))},[properties]);
  useEffect(()=>{setUEdit(JSON.parse(JSON.stringify(users)))},[users]);

  const mk=()=>setDirty(true);
  const save=()=>{onSave(cEdit,pEdit,uEdit);setDirty(false)};
  const countyNames=Object.keys(cEdit);

  // County limit editors
  const updateLim=(ti,pi,val)=>{const next={...cEdit};const c={...next[selCounty]};c.limits=c.limits.map((row,i)=>i===ti?row.map((v,j)=>j===pi?(val===""?0:+val):v):[...row]);next[selCounty]=c;setCEdit(next);mk()};
  const addCounty=()=>{if(!newCounty.trim()||cEdit[newCounty])return;const tmpl={label:`FY 2025 HUD Income Limits — ${newCounty}`,medianIncome:0,tiers:[0.3,0.5,0.6,0.8,1.0],personCounts:[1,2,3,4,5,6,7,8],limits:[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]]};setCEdit({...cEdit,[newCounty]:tmpl});setSelCounty(newCounty);setNewCounty("");mk()};
  const removeCounty=(name)=>{if(!confirm(`Remove "${name}" county limits?`))return;const next={...cEdit};delete next[name];setCEdit(next);if(selCounty===name)setSelCounty(Object.keys(next)[0]||"");mk()};

  // Property editors
  const updatePropName=(pi,name)=>{const n=[...pEdit];n[pi]={...n[pi],name};setPEdit(n);mk()};
  const updatePropCounty=(pi,county)=>{const n=[...pEdit];n[pi]={...n[pi],county};setPEdit(n);mk()};
  const updateUnit=(pi,ui,field,val)=>{const n=JSON.parse(JSON.stringify(pEdit));n[pi].units[ui][field]=val===""?0:+val;setPEdit(n);mk()};
  const updateUnitAmi=(pi,ui,val)=>{const n=JSON.parse(JSON.stringify(pEdit));n[pi].units[ui].ami=val===""?0:+val;setPEdit(n);mk()};
  const addUnit=(pi)=>{const n=JSON.parse(JSON.stringify(pEdit));n[pi].units.push({bedrooms:1,ami:0.6,maxRent:0,marketRent:0,count:1});setPEdit(n);mk()};
  const removeUnit=(pi,ui)=>{const n=JSON.parse(JSON.stringify(pEdit));n[pi].units=n[pi].units.filter((_,i)=>i!==ui);setPEdit(n);mk()};
  const addProp=()=>{setPEdit([...pEdit,{name:"New Property",county:countyNames[0]||"",units:[{bedrooms:1,ami:0.6,maxRent:0,marketRent:0,count:1}]}]);mk()};
  const removeProp=(pi)=>{if(!confirm(`Remove "${pEdit[pi].name}"?`))return;setPEdit(pEdit.filter((_,i)=>i!==pi));mk()};

  // User editors
  const addUser=()=>{if(!newUserEmail.trim())return;if(uEdit.find(u=>u.email.toLowerCase()===newUserEmail.toLowerCase()))return alert("User already exists");setUEdit([...uEdit,{email:newUserEmail.toLowerCase().trim(),name:newUserName.trim()||newUserEmail.split("@")[0],role:newUserRole}]);setNewUserEmail("");setNewUserName("");setNewUserRole("manager");mk()};
  const removeUser=(idx)=>{if(!confirm(`Remove ${uEdit[idx].name}?`))return;setUEdit(uEdit.filter((_,i)=>i!==idx));mk()};
  const changeRole=(idx,role)=>{const n=[...uEdit];n[idx]={...n[idx],role};setUEdit(n);mk()};

  const curLim=cEdit[selCounty];

  return(
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"}}>
        <div style={{display:"flex",background:B.teal900,borderRadius:"4px",border:`1px solid ${B.teal600}`}}>
          {[{key:"limits",label:"Income Limits"},{key:"properties",label:"Properties & Units"},{key:"users",label:"Users & Roles"}].map(t=>
            <button key={t.key} onClick={()=>setATab(t.key)} style={{background:aTab===t.key?`${B.gold500}18`:"transparent",border:"none",color:aTab===t.key?B.gold500:B.teal300,padding:"6px 14px",fontSize:"11px",fontWeight:700,cursor:"pointer",borderRadius:"3px",fontFamily:fb,textTransform:"uppercase",letterSpacing:"0.5px"}}>{t.label}</button>
          )}
        </div>
        <div style={{display:"flex",gap:"8px",alignItems:"center"}}>
          {lastSaved&&<span style={{fontSize:"10px",color:B.teal300}}>Last saved: {lastSaved}</span>}
          {dirty&&<span style={{fontSize:"10px",color:B.gold500,fontWeight:700}}>● Unsaved</span>}
          {isAdmin&&<Btn onClick={save} disabled={!dirty||saving} style={{padding:"6px 16px"}}>{saving?"Saving...":"Save Changes"}</Btn>}
        </div>
      </div>

      {/* INCOME LIMITS — per county tabs */}
      {aTab==="limits"&&(
        <Card>
          <div style={{display:"flex",gap:"4px",marginBottom:"12px",flexWrap:"wrap",alignItems:"center"}}>
            {countyNames.map(c=><button key={c} onClick={()=>setSelCounty(c)} style={{background:selCounty===c?`${B.gold500}22`:"transparent",border:`1px solid ${selCounty===c?B.gold500:B.teal600}`,color:selCounty===c?B.gold500:B.teal300,padding:"4px 10px",fontSize:"10px",fontWeight:700,cursor:"pointer",borderRadius:"3px",fontFamily:fb}}>{c}{isAdmin&&countyNames.length>1&&<span onClick={e=>{e.stopPropagation();removeCounty(c)}} style={{marginLeft:"6px",color:B.no,cursor:"pointer"}}>×</span>}</button>)}
            {isAdmin&&<div style={{display:"flex",gap:"4px",marginLeft:"8px"}}><I value={newCounty} onChange={setNewCounty} placeholder="New county name..." style={{width:"180px",fontSize:"10px",padding:"4px 6px"}}/><Btn v="small" onClick={addCounty} style={{padding:"3px 8px",fontSize:"9px"}}>+ County</Btn></div>}
          </div>
          {curLim&&<>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 120px",gap:"8px",marginBottom:"14px"}}>
              <F label="Label / Fiscal Year"><I value={curLim.label} onChange={v=>{const n={...cEdit};n[selCounty]={...n[selCounty],label:v};setCEdit(n);mk()}} disabled={!isAdmin} placeholder="FY 2025..."/></F>
              <F label="Area Median Income"><I type="number" value={curLim.medianIncome} onChange={v=>{const n={...cEdit};n[selCounty]={...n[selCounty],medianIncome:v===""?0:+v};setCEdit(n);mk()}} disabled={!isAdmin} placeholder="82400"/></F>
              <div/>
            </div>
            <div style={{overflowX:"auto"}}>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}>
                <thead><tr style={{borderBottom:`2px solid ${B.gold500}`}}>
                  <th style={{padding:"6px 8px",textAlign:"left",color:B.gold500,fontWeight:700,fontSize:"10px",fontFamily:fb}}>AMI Tier</th>
                  {curLim.personCounts.map(p=><th key={p} style={{padding:"6px 4px",textAlign:"center",color:B.teal300,fontWeight:700,fontSize:"10px",fontFamily:fb}}>{p} Person{p>1?"s":""}</th>)}
                </tr></thead>
                <tbody>{curLim.tiers.map((tier,ti)=>
                  <tr key={ti} style={{borderBottom:`1px solid ${B.teal600}33`}}>
                    <td style={{padding:"4px 8px",color:B.gold400,fontWeight:700,fontFamily:fm,fontSize:"12px"}}>{(tier*100).toFixed(0)}%</td>
                    {curLim.personCounts.map((_,pi)=><td key={pi} style={{padding:"2px 3px"}}>
                      {isAdmin?<input type="number" value={curLim.limits[ti][pi]} onChange={e=>updateLim(ti,pi,e.target.value)} style={{...iCss,width:"80px",textAlign:"right",fontSize:"11px",padding:"4px 6px"}}/>
                      :<span style={{fontFamily:fm,fontSize:"11px",color:B.white}}>${curLim.limits[ti][pi].toLocaleString()}</span>}
                    </td>)}
                  </tr>
                )}</tbody>
              </table>
            </div>
            <div style={{marginTop:"10px",fontSize:"10px",color:B.teal300}}>Update when HUD publishes new limits (usually June each year).</div>
          </>}
        </Card>
      )}

      {/* PROPERTIES & UNITS */}
      {aTab==="properties"&&(
        <div>
          {pEdit.map((prop,pi)=>(
            <Card key={pi} style={{marginBottom:"10px"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px"}}>
                <div style={{display:"flex",gap:"8px",flex:1,marginRight:"10px",alignItems:"center"}}>
                  {isAdmin?<I value={prop.name} onChange={v=>updatePropName(pi,v)} style={{fontSize:"14px",fontWeight:700,fontFamily:fb,flex:1}}/>:<span style={{fontSize:"14px",fontWeight:700,color:B.white}}>{prop.name}</span>}
                  {isAdmin?<Sel value={prop.county||""} onChange={v=>updatePropCounty(pi,v)} options={countyNames} placeholder="County" style={{width:"200px",fontSize:"11px"}}/>:<span style={{fontSize:"11px",color:B.teal300,marginLeft:"8px"}}>{prop.county}</span>}
                </div>
                {isAdmin&&<div style={{display:"flex",gap:"4px"}}><Btn v="small" onClick={()=>addUnit(pi)} style={{padding:"3px 8px",fontSize:"10px"}}>+ Unit</Btn><Btn v="danger" onClick={()=>removeProp(pi)} style={{padding:"3px 8px",fontSize:"10px"}}>Remove</Btn></div>}
              </div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}>
                <thead><tr style={{borderBottom:`1px solid ${B.teal600}`}}>{["BR","AMI %","Max AMI Rent","Market Rent","Unit Count",isAdmin?"":""].filter(Boolean).map((h,i)=><th key={i} style={{padding:"4px 6px",textAlign:i>1?"center":"left",color:B.teal300,fontWeight:700,fontSize:"9px",textTransform:"uppercase"}}>{h}</th>)}</tr></thead>
                <tbody>{prop.units.map((unit,ui)=>
                  <tr key={ui} style={{borderBottom:`1px solid ${B.teal600}22`}}>
                    <td style={{padding:"3px 4px",width:"60px"}}>{isAdmin?<input type="number" value={unit.bedrooms} onChange={e=>updateUnit(pi,ui,"bedrooms",e.target.value)} style={{...iCss,width:"50px",textAlign:"center",padding:"4px",fontSize:"11px"}}/>:<span style={{fontFamily:fm}}>{unit.bedrooms}</span>}</td>
                    <td style={{padding:"3px 4px",width:"80px"}}>{isAdmin?<select value={unit.ami} onChange={e=>updateUnitAmi(pi,ui,e.target.value)} style={{...iCss,width:"70px",padding:"4px",fontSize:"11px"}}>{[0.3,0.5,0.6,0.8,1.0].map(t=><option key={t} value={t}>{(t*100).toFixed(0)}%</option>)}</select>:<span style={{fontFamily:fm}}>{(unit.ami*100).toFixed(0)}%</span>}</td>
                    <td style={{padding:"3px 4px",width:"100px"}}>{isAdmin?<input type="number" value={unit.maxRent} onChange={e=>updateUnit(pi,ui,"maxRent",e.target.value)} style={{...iCss,width:"90px",textAlign:"right",padding:"4px 6px",fontSize:"11px"}}/>:<span style={{fontFamily:fm}}>${unit.maxRent}</span>}</td>
                    <td style={{padding:"3px 4px",width:"100px"}}>{isAdmin?<input type="number" value={unit.marketRent} onChange={e=>updateUnit(pi,ui,"marketRent",e.target.value)} style={{...iCss,width:"90px",textAlign:"right",padding:"4px 6px",fontSize:"11px"}}/>:<span style={{fontFamily:fm}}>${unit.marketRent}</span>}</td>
                    <td style={{padding:"3px 4px",width:"70px"}}>{isAdmin?<input type="number" value={unit.count} onChange={e=>updateUnit(pi,ui,"count",e.target.value)} style={{...iCss,width:"55px",textAlign:"center",padding:"4px",fontSize:"11px"}}/>:<span style={{fontFamily:fm}}>{unit.count}</span>}</td>
                    {isAdmin&&<td style={{padding:"3px 4px",width:"30px",textAlign:"center"}}><button onClick={()=>removeUnit(pi,ui)} style={{background:"transparent",border:"none",color:B.no,cursor:"pointer",fontSize:"14px"}}>×</button></td>}
                  </tr>
                )}</tbody>
              </table>
            </Card>
          ))}
          {isAdmin&&<Btn v="small" onClick={addProp} style={{marginTop:"4px"}}>+ Add Property</Btn>}
        </div>
      )}

      {/* USERS & ROLES */}
      {aTab==="users"&&(
        <Card>
          <div style={sCss}>Users & Roles</div>
          <div style={{fontSize:"10px",color:B.teal300,marginBottom:"12px"}}>
            <b>Manager</b> — View calculator & history, reprint decisions | <b>Approver</b> — Submit verifications | <b>Admin</b> — Override denials, edit config, manage users
          </div>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px",marginBottom:"12px"}}>
            <thead><tr style={{borderBottom:`2px solid ${B.gold500}`}}>
              {["Email","Name","Role",isAdmin?"":""].filter(Boolean).map((h,i)=><th key={i} style={{padding:"6px 8px",textAlign:"left",color:B.gold500,fontWeight:700,fontSize:"10px",fontFamily:fb,textTransform:"uppercase"}}>{h}</th>)}
            </tr></thead>
            <tbody>{uEdit.map((u,i)=>
              <tr key={i} style={{borderBottom:`1px solid ${B.teal600}33`}}>
                <td style={{padding:"5px 8px",color:B.white,fontFamily:fm,fontSize:"11px"}}>{u.email}</td>
                <td style={{padding:"5px 8px",color:B.white}}>{u.name}</td>
                <td style={{padding:"5px 8px"}}>{isAdmin?<select value={u.role} onChange={e=>changeRole(i,e.target.value)} style={{...iCss,width:"120px",padding:"3px 6px",fontSize:"11px"}}>{Object.entries(ROLE_LABELS).map(([k,v])=><option key={k} value={k}>{v}</option>)}</select>:<span style={{padding:"2px 8px",borderRadius:"3px",fontSize:"10px",fontWeight:700,background:u.role==="admin"?B.ovBg:u.role==="approver"?B.okBg:B.wBg,color:u.role==="admin"?B.ov:u.role==="approver"?B.ok:B.gold500,border:`1px solid ${u.role==="admin"?B.ovBr:u.role==="approver"?B.okBr:B.wBr}`}}>{ROLE_LABELS[u.role]}</span>}</td>
                {isAdmin&&<td style={{padding:"5px 8px"}}><button onClick={()=>removeUser(i)} style={{background:"transparent",border:"none",color:B.no,cursor:"pointer",fontSize:"13px"}}>×</button></td>}
              </tr>
            )}</tbody>
          </table>
          {isAdmin&&<div style={{display:"grid",gridTemplateColumns:"1fr 1fr 120px auto",gap:"6px",alignItems:"end"}}>
            <F label="Email"><I value={newUserEmail} onChange={setNewUserEmail} placeholder="user@company.com"/></F>
            <F label="Display Name"><I value={newUserName} onChange={setNewUserName} placeholder="Full name"/></F>
            <F label="Role"><Sel value={newUserRole} onChange={setNewUserRole} options={Object.entries(ROLE_LABELS).map(([k,v])=>({value:k,label:v}))}/></F>
            <Btn onClick={addUser} style={{marginBottom:"8px",padding:"7px 12px"}}>Add User</Btn>
          </div>}
        </Card>
      )}
    </div>
  );
}

// ============================================================
// HOUSE ICON
// ============================================================
function HouseIcon(){return(<svg viewBox="0 0 28 28" width="32" height="32" style={{marginRight:"10px"}}><path d="M14 2L2 12h3v12h7v-7h4v7h7V12h3L14 2z" fill={B.gold500} opacity="0.9"/><rect x="11" y="12" width="6" height="5" rx="0.5" fill={B.teal800}/><circle cx="15.5" cy="14.5" r="0.6" fill={B.gold500}/><line x1="1" y1="13" x2="8" y2="13" stroke={B.gold500} strokeWidth="1.2"/><line x1="20" y1="13" x2="27" y2="13" stroke={B.gold500} strokeWidth="1.2"/></svg>)}

// ============================================================
// PRINT RESULT — includes override info
// ============================================================
function PrintResult({fd,pr,ar,total,breakdown,reviewer,limitsLabel,overrideStatus,overrideBy,overrideNotes,vDate}){
  const isOvr=overrideStatus==="OVERRIDE_APPROVED";
  const finalResult=isOvr?"OVERRIDE APPROVED":pr.result;
  const finalColor=isOvr?"#6A8EC8":pr.result==="APPROVED"?"#3DA06B":"#D35B4B";
  return(
    <div id="printable-result" style={{background:"#fff",borderRadius:"6px",padding:"28px 32px",margin:"12px 0",color:"#1a1a1a",fontFamily:fb,fontSize:"12px"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",borderBottom:"2px solid #28434C",paddingBottom:"12px",marginBottom:"16px"}}>
        <div><div style={{fontSize:"9px",fontWeight:700,color:"#CDA04B",textTransform:"uppercase",letterSpacing:"2px"}}>NewShire Property Management</div><div style={{fontSize:"18px",fontWeight:900,color:"#28434C"}}>AMI Income Verification</div><div style={{fontSize:"10px",color:"#666",marginTop:"2px"}}>{limitsLabel}</div></div>
        <div style={{textAlign:"right"}}><div style={{fontSize:"10px",color:"#666"}}>Date: {new Date(vDate+"T12:00:00").toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}</div><div style={{fontSize:"10px",color:"#666"}}>Reviewer: {reviewer}</div></div>
      </div>
      <div style={{display:"flex",gap:"12px",marginBottom:"16px"}}>
        <div style={{flex:1}}>
          <div style={{fontSize:"10px",fontWeight:700,color:"#28434C",textTransform:"uppercase",letterSpacing:"1px",marginBottom:"6px",borderBottom:"1px solid #ddd",paddingBottom:"3px"}}>Applicant & Property</div>
          <table style={{width:"100%",fontSize:"11px",borderCollapse:"collapse"}}><tbody>
            <tr><td style={{padding:"3px 0",color:"#666",width:"120px"}}>Applicant</td><td style={{fontWeight:700}}>{fd.primaryApplicant}{fd.allApplicantNames!==fd.primaryApplicant&&<span style={{fontWeight:400,color:"#666"}}> + {fd.allApplicantNames.split(",").length-1} co-applicant(s)</span>}</td></tr>
            <tr><td style={{padding:"3px 0",color:"#666"}}>Property</td><td>{fd.propertyName}</td></tr>
            <tr><td style={{padding:"3px 0",color:"#666"}}>Unit</td><td>{fd.unitNumber||"—"}</td></tr>
            <tr><td style={{padding:"3px 0",color:"#666"}}>Bedrooms</td><td>{fd.bedrooms}</td></tr>
            <tr><td style={{padding:"3px 0",color:"#666"}}>AMI Tier</td><td>{(fd.amiTier*100).toFixed(0)}%</td></tr>
            <tr><td style={{padding:"3px 0",color:"#666"}}>Occupants</td><td>{fd.occupants}</td></tr>
            <tr><td style={{padding:"3px 0",color:"#666"}}>Monthly Rent</td><td>${(+fd.monthlyRent).toLocaleString()}</td></tr>
          </tbody></table>
        </div>
        <div style={{flex:1}}>
          <div style={{fontSize:"10px",fontWeight:700,color:"#28434C",textTransform:"uppercase",letterSpacing:"1px",marginBottom:"6px",borderBottom:"1px solid #ddd",paddingBottom:"3px"}}>Income Summary</div>
          <table style={{width:"100%",fontSize:"11px",borderCollapse:"collapse"}}><tbody>
            {breakdown.filter(b=>b.amount>0).map((b,i)=><tr key={i}><td style={{padding:"3px 0",color:"#666"}}>{b.label}</td><td style={{textAlign:"right"}}>${b.amount.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})}</td></tr>)}
            <tr style={{borderTop:"2px solid #28434C"}}><td style={{padding:"6px 0",fontWeight:800}}>Total Annual Income</td><td style={{textAlign:"right",fontWeight:800,fontSize:"13px"}}>${total.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:0})}</td></tr>
          </tbody></table>
        </div>
      </div>
      <div style={{background:isOvr?"#f0f4fa":pr.result==="APPROVED"?"#f0faf5":"#fdf5f4",border:`2px solid ${finalColor}`,borderRadius:"6px",padding:"14px 18px",marginBottom:"14px"}}>
        <div style={{fontSize:"16px",fontWeight:900,color:finalColor,marginBottom:"4px"}}>{isOvr?"⚖ ":pr.result==="APPROVED"?"✓ ":"✗ "}{finalResult}</div>
        {pr.result==="DENIED"&&!isOvr&&<div style={{fontSize:"11px",color:"#666"}}>Reason: {pr.reason} — Variance: ${Math.round(pr.variance).toLocaleString()}</div>}
        {pr.result==="DENIED"&&isOvr&&<div style={{fontSize:"11px",color:"#666",marginTop:"4px"}}>
          <div>Original Decision: DENIED — {pr.reason}</div>
          <div style={{marginTop:"4px",fontWeight:700,color:"#6A8EC8"}}>Override Authorized By: {overrideBy}</div>
          <div>Override Reason: {overrideNotes}</div>
        </div>}
        <div style={{fontSize:"10px",color:"#999",marginTop:"6px"}}>
          Income Limit: ${pr.limit?.toLocaleString()} | Effective Persons: {pr.eff} (Anchor: {pr.anchor}) | Min Monthly: ${Math.round(pr.minMo).toLocaleString()} | Actual Monthly: ${Math.round(pr.mo).toLocaleString()}
        </div>
      </div>
      {ar&&!isOvr&&<div style={{background:"#fffbf0",border:"1px solid #e0c680",borderRadius:"6px",padding:"10px 14px",marginBottom:"14px"}}>
        <div style={{fontSize:"12px",fontWeight:700,color:ar.result==="APPROVED"?"#3DA06B":"#D35B4B"}}>Alt Tier Review (80% AMI): {ar.result}</div>
        {ar.reason&&<div style={{fontSize:"11px",color:"#666"}}>{ar.reason} — Variance: ${Math.round(ar.variance).toLocaleString()}</div>}
        <div style={{fontSize:"10px",color:"#999"}}>Limit: ${ar.limit?.toLocaleString()} | Eff. Persons: {ar.eff}</div>
      </div>}
      <div style={{borderTop:"1px solid #ddd",paddingTop:"10px",display:"flex",justifyContent:"space-between",fontSize:"9px",color:"#999"}}>
        <span>NewShire Property Management — AMI Verification Calculator</span><span>Generated {new Date().toLocaleString()}</span>
      </div>
    </div>
  );
}

// ============================================================
// MAIN COMPONENT
// ============================================================
window.AMICalculator = function AMICalculator(){
  const[tab,setTab]=useState("calculator");
  const auth=useMsal();

  // Config state — multi-county
  const[counties,setCounties]=useState(DEFAULT_COUNTIES);
  const[properties,setProperties]=useState(DEFAULT_PROPERTIES);
  const[users,setUsers]=useState(DEFAULT_USERS);
  const[cfgDone,setCfgDone]=useState(false);
  const[cfgSaved,setCfgSaved]=useState("");
  const[adminSaving,setAdminSaving]=useState(false);

  // Determine user role
  const userEmail=auth.user?.username?.toLowerCase()||"";
  const userRecord=users.find(u=>u.email===userEmail);
  const userRole=userRecord?.role||(CONFIG.seedAdmins.includes(userEmail)?"admin":null);
  const isAdmin=userRole==="admin";
  const isApprover=userRole==="approver"||isAdmin;
  const isManager=userRole==="manager"||isApprover;

  // Load config
  useEffect(()=>{
    if(!CONFIG.isConfigured){setCfgDone(true);return}
    (async()=>{try{
      const tok=await auth.getToken();
      if(tok){const cfg=await cfgLoad(tok);if(cfg){
        if(cfg.counties?.counties){setCounties(cfg.counties.counties);if(cfg.counties.users)setUsers(cfg.counties.users)}
        else if(cfg.counties&&!cfg.counties.counties){/* Legacy single-county format */setCounties({"Spartanburg County, SC":cfg.counties})}
        setProperties(cfg.properties);
        setCfgSaved(`${new Date(cfg.lastModified).toLocaleDateString("en-US",{month:"short",day:"numeric"})}`);
      }}
    }catch(e){console.error("Cfg load:",e)}setCfgDone(true)})();
  },[auth.status]);

  // Admin save
  const handleAdminSave=async(newC,newP,newU)=>{
    if(!CONFIG.isConfigured){setCounties(newC);setProperties(newP);setUsers(newU);return}
    setAdminSaving(true);
    try{const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");
      await cfgSave(tok,newC,newP,newU,auth.user?.name||userEmail||"Unknown");
      setCounties(newC);setProperties(newP);setUsers(newU);setCfgSaved("Just now");
    }catch(e){alert(`Save failed: ${e.message}`)}
    setAdminSaving(false);
  };

  // Calculator form state
  const[reviewer,setReviewer]=useState("");
  const[vDate,setVDate]=useState(new Date().toISOString().slice(0,10));
  const[primaryApplicantName,setPAN]=useState("");
  const[propIdx,setPropIdx]=useState("");
  const[unitCfg,setUnitCfg]=useState(null);
  const[unitNum,setUnitNum]=useState("");
  const[occ,setOcc]=useState("");
  const[rent,setRent]=useState("");
  const[applicants,setApplicants]=useState([{name:"",paystubs:["","","",""],paystubFrequency:""}]);
  const[offers,setOffers]=useState([{name:"",hourly:"",hoursPerWeek:"",salary:""}]);
  const[banks,setBanks]=useState([{name:"",deposits:["","",""]}]);
  const[other,setOther]=useState([]);
  const[notes,setNotes]=useState("");
  const[submitSt,setSubmitSt]=useState("idle");
  const[submitErr,setSubmitErr]=useState("");
  const[history,setHistory]=useState([]);
  const[histLoad,setHistLoad]=useState(false);
  // Override state
  const[showOverride,setShowOverride]=useState(false);
  const[ovrNotes,setOvrNotes]=useState("");
  const[ovrSaving,setOvrSaving]=useState(false);
  const[overrideStatus,setOverrideStatus]=useState(null); // null | "OVERRIDE_APPROVED"
  const[overrideBy,setOverrideBy]=useState("");
  const[overrideNotesDisplay,setOverrideNotesDisplay]=useState("");
  const[lastSubmittedId,setLastSubmittedId]=useState(null);

  // Derived
  const prop=propIdx!==""?properties[propIdx]:null;
  const countyLimits=prop&&counties[prop.county]?counties[prop.county]:counties[Object.keys(counties)[0]];
  const units=prop?[...new Map(prop.units.map(u=>[`${u.bedrooms}-${u.ami}`,u])).values()]:[];
  const br=unitCfg?.bedrooms??0,ami=unitCfg?.ami??0;
  const pAnn=applicants.reduce((s,a)=>s+calcPS(a.paystubs||[],a.paystubFrequency||""),0);
  const oAnn=offers.reduce((s,o)=>s+calcOL(o.hourly,o.hoursPerWeek,o.salary),0);
  const bAnn=banks.reduce((s,b)=>s+calcBK(b.deposits||[]),0);
  const otAnn=calcOth(other);
  const total=pAnn+oAnn+bAnn+otAnn;
  const breakdown=[{label:"Paystub Income",amount:pAnn},{label:"Offer Letter",amount:oAnn},{label:"Bank Statements",amount:bAnn},{label:"Other Income",amount:otAnn}];

  const canRun=unitCfg&&total>0&&rent&&countyLimits;
  let pr=null,ar=null;
  if(canRun){
    const eff=occ?+occ:anchorP(br);
    pr=verify({tier:ami,br,occ:eff,income:total,rent:+rent,lim:countyLimits});
    if(pr.result==="DENIED"&&ami<0.8){const au=prop.units.find(u=>u.bedrooms===br&&u.ami===0.8);ar=verify({tier:0.8,br,occ:eff,income:total,rent:au?au.marketRent:+rent,lim:countyLimits})}
  }

  // History load
  useEffect(()=>{
    if(tab==="history"&&CONFIG.isConfigured&&auth.user){
      (async()=>{setHistLoad(true);try{const t=await auth.getToken();if(t)setHistory(await spHistory(t))}catch(e){}setHistLoad(false)})();
    }
  },[tab,auth.user]);

  // Load history record into form
  const loadFromHistory=(rec)=>{
    if(userRole==="manager"){
      // Managers: open print view only (read-only reprint)
      // We'll still populate but they can't submit
    }
    // Find property index
    const pi=properties.findIndex(p=>p.name===rec.Property);
    if(pi>=0)setPropIdx(String(pi));
    setPAN(rec.ApplicantName?.split(",")[0]||"");
    setReviewer(rec.Reviewer||"");
    setVDate(rec.DateCompleted?new Date(rec.DateCompleted).toISOString().slice(0,10):new Date().toISOString().slice(0,10));
    setUnitNum(rec.UnitAddress||"");
    setOcc(rec.Occupants?String(rec.Occupants):"");
    setRent(rec.MonthlyRent?String(rec.MonthlyRent):"");
    setNotes(rec.VerificationNotes||"");
    // Set unit config after property loads
    setTimeout(()=>{
      const p=properties[pi];
      if(p){const u=p.units.find(u=>u.bedrooms===+rec.Bedrooms&&u.ami===+rec.AMITier);if(u)setUnitCfg(u)}
    },50);
    // Restore override state if exists
    if(rec.Result?.includes("Override")){setOverrideStatus("OVERRIDE_APPROVED");setOverrideBy(rec.OverrideBy||"");setOverrideNotesDisplay(rec.OverrideNotes||"")}
    else{setOverrideStatus(null);setOverrideBy("");setOverrideNotesDisplay("")}
    setLastSubmittedId(null);setSubmitSt("idle");setSubmitErr("");setShowOverride(false);setOvrNotes("");
    setTab("calculator");
  };

  const coNames=[...applicants,...offers,...banks].filter(a=>a.name).map(a=>a.name);
  const primaryApplicant=primaryApplicantName.trim()||coNames[0]||"";
  const allApplicantNames=[...new Set([primaryApplicant,...coNames].filter(Boolean))].join(", ");
  const fd={propertyName:prop?.name||"",unitNumber:unitNum,bedrooms:br,amiTier:ami,occupants:occ||anchorP(br),monthlyRent:rent,primaryApplicant,allApplicantNames};

  const handleSubmit=async()=>{
    if(!isApprover){setSubmitErr("Approver or Admin role required");setSubmitSt("error");return}
    if(!reviewer.trim()){setSubmitErr("Reviewer name required");setSubmitSt("error");return}
    setSubmitSt("submitting");
    try{
      const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");
      const res=await spWrite(tok,{
        Title:`${prop.name} - ${unitNum||"—"} - ${primaryApplicant||"Unknown"}`,DateCompleted:new Date(vDate+"T12:00:00").toISOString(),
        Reviewer:reviewer,Property:prop.name,UnitAddress:unitNum,ApplicantName:allApplicantNames,
        Bedrooms:br,AMITier:ami,Occupants:occ?+occ:anchorP(br),
        IncomeLimit:pr.limit,TotalIncome:Math.round(total*100)/100,MonthlyRent:+rent,
        Result:pr.result==="APPROVED"?"Approved":`Denied - ${pr.reason}`,
        Variance:Math.round(pr.variance*100)/100,DenialReason:pr.reason||"",
        AltAMITier:ar?0.8:null,AltIncomeLimit:ar?ar.limit:null,
        AltResult:ar?(ar.result==="APPROVED"?"Approved":`Denied - ${ar.reason}`):"",
        AltVariance:ar?Math.round(ar.variance*100)/100:null,AltDenialReason:ar?(ar.reason||""):"",
        PaystubIncome:Math.round(pAnn*100)/100,OfferLetterIncome:Math.round(oAnn*100)/100,
        BankStatementIncome:Math.round(bAnn*100)/100,OtherIncome:Math.round(otAnn*100)/100,
        EffectivePersons:pr.eff,AnchorPersons:pr.anchor,VerificationNotes:notes,
      });
      setLastSubmittedId(res?.id||null);
      setSubmitSt("success");setTimeout(()=>setSubmitSt("idle"),4000);
    }catch(e){setSubmitErr(e.message);setSubmitSt("error")}
  };

  const handleOverride=async()=>{
    if(!isAdmin){alert("Admin role required");return}
    if(!ovrNotes.trim()){alert("Override notes are required");return}
    setOvrSaving(true);
    try{
      const tok=await auth.getToken();if(!tok)throw new Error("Auth failed");
      // If we have a submitted record, update it
      if(lastSubmittedId){
        await spUpdate(tok,lastSubmittedId,{Result:"Override Approved",OverrideBy:auth.user?.name||userEmail,OverrideNotes:ovrNotes});
      }else{
        // Submit as new record with override
        await spWrite(tok,{
          Title:`${prop.name} - ${unitNum||"—"} - ${primaryApplicant||"Unknown"} [OVERRIDE]`,DateCompleted:new Date(vDate+"T12:00:00").toISOString(),
          Reviewer:reviewer,Property:prop.name,UnitAddress:unitNum,ApplicantName:allApplicantNames,
          Bedrooms:br,AMITier:ami,Occupants:occ?+occ:anchorP(br),
          IncomeLimit:pr.limit,TotalIncome:Math.round(total*100)/100,MonthlyRent:+rent,
          Result:"Override Approved",Variance:Math.round(pr.variance*100)/100,
          DenialReason:pr.reason||"",OverrideBy:auth.user?.name||userEmail,OverrideNotes:ovrNotes,
          AltAMITier:ar?0.8:null,AltIncomeLimit:ar?ar.limit:null,
          AltResult:ar?(ar.result==="APPROVED"?"Approved":`Denied - ${ar.reason}`):"",
          AltVariance:ar?Math.round(ar.variance*100)/100:null,AltDenialReason:ar?(ar.reason||""):"",
          PaystubIncome:Math.round(pAnn*100)/100,OfferLetterIncome:Math.round(oAnn*100)/100,
          BankStatementIncome:Math.round(bAnn*100)/100,OtherIncome:Math.round(otAnn*100)/100,
          EffectivePersons:pr.eff,AnchorPersons:pr.anchor,VerificationNotes:notes,
        });
      }
      setOverrideStatus("OVERRIDE_APPROVED");setOverrideBy(auth.user?.name||userEmail);setOverrideNotesDisplay(ovrNotes);setShowOverride(false);
    }catch(e){alert(`Override failed: ${e.message}`)}
    setOvrSaving(false);
  };

  const reset=()=>{
    setPropIdx("");setUnitCfg(null);setUnitNum("");setOcc("");setRent("");setPAN("");setVDate(new Date().toISOString().slice(0,10));
    setApplicants([{name:"",paystubs:["","","",""],paystubFrequency:""}]);
    setOffers([{name:"",hourly:"",hoursPerWeek:"",salary:""}]);
    setBanks([{name:"",deposits:["","",""]}]);
    setOther([]);setNotes("");setSubmitSt("idle");setSubmitErr("");
    setShowOverride(false);setOvrNotes("");setOverrideStatus(null);setOverrideBy("");setOverrideNotesDisplay("");setLastSubmittedId(null);
  };

  const handlePrint=()=>{
    const el=document.getElementById("printable-result");if(!el)return;
    const w=window.open("","_blank");
    w.document.write(`<html><head><title>AMI Verification</title><link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700;800&family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet"><style>body{margin:0;padding:20px;font-family:'Source Sans 3',sans-serif;}@media print{body{padding:0;}}</style></head><body>${el.outerHTML}</body></html>`);
    w.document.close();setTimeout(()=>w.print(),500);
  };

  // Get first county label for header
  const firstCounty=Object.values(counties)[0];
  const headerLabel=Object.keys(counties).length===1?firstCounty?.label:`${Object.keys(counties).length} Coverage Areas`;

  if(!cfgDone)return(<div style={{background:B.teal900,minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:fb}}><div style={{textAlign:"center",color:B.teal300}}><div style={{fontSize:"14px",marginBottom:"6px"}}>Loading configuration...</div><div style={{fontSize:"11px",color:B.gray400}}>Connecting to SharePoint</div></div></div>);

  return(
    <div style={{background:`linear-gradient(180deg,${B.teal900} 0%,${B.teal800} 100%)`,minHeight:"100vh",color:B.white,fontFamily:fb}}>
      {/* HEADER */}
      <div style={{background:B.teal700,borderBottom:`2px solid ${B.gold500}`,padding:"12px 20px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
        <div style={{display:"flex",alignItems:"center"}}>
          <HouseIcon/>
          <div>
            <div style={{fontSize:"10px",fontWeight:700,color:B.gold500,textTransform:"uppercase",letterSpacing:"2px"}}>NewShire Property Management</div>
            <div style={{fontSize:"18px",fontWeight:900,color:B.white,letterSpacing:"-0.2px",lineHeight:"1.1"}}>AMI Verification Calculator</div>
            <div style={{fontSize:"10px",color:B.teal300,marginTop:"1px"}}>{headerLabel}</div>
          </div>
        </div>
        <div style={{display:"flex",gap:"6px",alignItems:"center"}}>
          <div style={{display:"flex",background:B.teal900,borderRadius:"4px",border:`1px solid ${B.teal600}`,marginRight:"8px"}}>
            {[{key:"calculator",label:"Calculator"},{key:"history",label:"History"},{key:"admin",label:"⚙ Admin"}].map(t=>
              <button key={t.key} onClick={()=>setTab(t.key)} style={{background:tab===t.key?`${B.gold500}18`:"transparent",border:"none",color:tab===t.key?B.gold500:B.teal300,padding:"5px 12px",fontSize:"11px",fontWeight:700,cursor:"pointer",borderRadius:"3px",fontFamily:fb,textTransform:"uppercase",letterSpacing:"0.5px"}}>{t.label}</button>
            )}
          </div>
          {canRun&&pr&&tab==="calculator"&&<Btn onClick={handlePrint}>Print Result</Btn>}
          {tab==="calculator"&&<Btn v="secondary" onClick={reset}>Reset</Btn>}
          {auth.user?(<span style={{fontSize:"10px",color:B.teal300,marginLeft:"4px",fontFamily:fb}}>✓ {auth.user.name||auth.user.username}{userRole&&<span style={{marginLeft:"4px",opacity:0.7}}>({ROLE_LABELS[userRole]||"No Role"})</span>}</span>)
          :CONFIG.isConfigured?(<Btn v="small" onClick={async()=>{await auth.getToken()}} style={{marginLeft:"4px",padding:"4px 10px",fontSize:"10px"}}>Sign In</Btn>):null}
        </div>
      </div>

      <div style={{padding:"16px 20px",maxWidth:"1200px"}}>

        {/* Sign-in gate for all tabs */}
        {!auth.user&&CONFIG.isConfigured?(
          <Card><div style={{textAlign:"center",padding:"40px",color:B.teal300}}>
            <div style={{fontSize:"24px",marginBottom:"8px"}}>🔑</div>
            <div style={{fontSize:"14px",fontWeight:700,marginBottom:"8px"}}>Sign In Required</div>
            <div style={{fontSize:"12px",color:B.gray400,marginBottom:"14px"}}>Sign in with your Microsoft 365 account to access the calculator.</div>
            <Btn onClick={async()=>{await auth.getToken()}}>Sign In with Microsoft</Btn>
          </div></Card>
        ):auth.user&&!userRole?(
          <Card><div style={{textAlign:"center",padding:"40px",color:B.teal300}}>
            <div style={{fontSize:"24px",marginBottom:"8px"}}>🚫</div>
            <div style={{fontSize:"14px",fontWeight:700,marginBottom:"8px"}}>No Access</div>
            <div style={{fontSize:"12px",color:B.gray400}}>Your account ({userEmail}) has not been assigned a role. Contact an administrator.</div>
          </div></Card>
        ):<>

        {/* ADMIN TAB — viewable by all roles, editable only by admin */}
        {tab==="admin"&&<AdminPanel counties={counties} properties={properties} users={users} onSave={handleAdminSave} saving={adminSaving} lastSaved={cfgSaved} isAdmin={isAdmin}/>}

        {/* HISTORY TAB — viewable by all roles */}
        {tab==="history"&&<HistoryPanel history={history} loading={histLoad} onSelect={loadFromHistory} userRole={userRole}/>}

        {/* CALCULATOR TAB */}
        {tab==="calculator"&&(
          <>
            {!isApprover&&<div style={{background:B.wBg,border:`1px solid ${B.wBr}`,borderRadius:"6px",padding:"8px 14px",marginBottom:"12px",fontSize:"11px",color:B.gold500,fontWeight:600}}>
              👁 View-only mode — You can use the calculator but cannot submit verifications. Contact an Admin or Approver to submit.
            </div>}
            <Card style={{marginBottom:"12px"}}>
              <div style={sCss}>Property & Unit Information</div>
              <div style={{display:"grid",gridTemplateColumns:"0.8fr 1fr 1.2fr 1.5fr 1fr 0.7fr 0.7fr 0.8fr",gap:"10px"}}>
                <F label="Date"><I type="date" value={vDate} onChange={setVDate}/></F>
                <F label="Reviewer"><I value={reviewer} onChange={setReviewer} placeholder="Your name"/></F>
                <F label="Primary Applicant"><I value={primaryApplicantName} onChange={setPAN} placeholder="Applicant full name"/></F>
                <F label="Property"><Sel value={propIdx} onChange={v=>{setPropIdx(v);setUnitCfg(null);setRent("")}} options={properties.map((p,i)=>({value:i,label:`${p.name} (${p.county?.split(",")[0]||""})`}))} placeholder="Select property"/></F>
                <F label="Unit Config"><Sel value={unitCfg?`${unitCfg.bedrooms}-${unitCfg.ami}`:""} onChange={v=>{const[b,a]=v.split("-").map(Number);const u=units.find(u=>u.bedrooms===b&&u.ami===a);setUnitCfg(u);if(u)setRent(String(u.marketRent))}} options={units.map(u=>({value:`${u.bedrooms}-${u.ami}`,label:`${u.bedrooms}BR / ${(u.ami*100).toFixed(0)}% AMI`}))} placeholder="Select"/></F>
                <F label="Unit #"><I value={unitNum} onChange={setUnitNum} placeholder="e.g. 162"/></F>
                <F label="Occupants"><I type="number" value={occ} onChange={setOcc} placeholder={unitCfg?String(anchorP(br)):"—"}/></F>
                <F label="Monthly Rent"><I type="number" value={rent} onChange={setRent} placeholder="0"/></F>
              </div>
              {unitCfg&&countyLimits&&(
                <div style={{background:B.teal900,border:`1px solid ${B.teal600}`,borderRadius:"4px",padding:"6px 10px",marginTop:"8px",fontSize:"10px",color:B.teal300,fontFamily:fm,display:"flex",gap:"20px",flexWrap:"wrap"}}>
                  <span>County: <b style={{color:B.white}}>{prop?.county}</b></span>
                  <span>BR: <b style={{color:B.white}}>{br}</b></span>
                  <span>Anchor: <b style={{color:B.gold400}}>{anchorP(br)}p</b></span>
                  <span>Effective: <b style={{color:B.gold500}}>{effP(br,occ?+occ:0)}p</b></span>
                  <span>AMI: <b style={{color:B.white}}>{(ami*100).toFixed(0)}%</b></span>
                  <span>Limit: <b style={{color:B.ok}}><Mon amount={getLimit(ami,effP(br,occ?+occ:0),countyLimits)}/></b></span>
                </div>
              )}
            </Card>

            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"12px",marginBottom:"12px"}}>
              <div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}}>
                  <span style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px"}}>Paystubs ({applicants.length} applicant{applicants.length>1?"s":""})</span>
                  <div style={{display:"flex",gap:"4px"}}>
                    {applicants.length<8&&<Btn v="small" onClick={()=>setApplicants([...applicants,{name:"",paystubs:["","","",""],paystubFrequency:""}])} style={{padding:"2px 6px",fontSize:"9px"}}>+ Applicant</Btn>}
                    {applicants.length>1&&<Btn v="danger" onClick={()=>setApplicants(applicants.slice(0,-1))} style={{padding:"2px 6px",fontSize:"9px"}}>Remove</Btn>}
                  </div>
                </div>
                {applicants.map((a,i)=><PaystubSec key={i} idx={i} data={a} onChange={d=>{const n=[...applicants];n[i]=d;setApplicants(n)}}/>)}
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px",marginTop:"10px"}}>
                  <span style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px"}}>Offer Letters ({offers.length} applicant{offers.length>1?"s":""})</span>
                  <div style={{display:"flex",gap:"4px"}}>
                    {offers.length<8&&<Btn v="small" onClick={()=>setOffers([...offers,{name:"",hourly:"",hoursPerWeek:"",salary:""}])} style={{padding:"2px 6px",fontSize:"9px"}}>+ Applicant</Btn>}
                    {offers.length>1&&<Btn v="danger" onClick={()=>setOffers(offers.slice(0,-1))} style={{padding:"2px 6px",fontSize:"9px"}}>Remove</Btn>}
                  </div>
                </div>
                {offers.map((o,i)=><OfferSec key={i} idx={i} data={o} onChange={d=>{const n=[...offers];n[i]=d;setOffers(n)}}/>)}
              </div>
              <div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px"}}>
                  <span style={{fontSize:"10px",fontWeight:700,color:B.teal300,textTransform:"uppercase",letterSpacing:"0.5px"}}>Bank Statements ({banks.length} applicant{banks.length>1?"s":""})</span>
                  <div style={{display:"flex",gap:"4px"}}>
                    {banks.length<8&&<Btn v="small" onClick={()=>setBanks([...banks,{name:"",deposits:["","",""]}])} style={{padding:"2px 6px",fontSize:"9px"}}>+ Applicant</Btn>}
                    {banks.length>1&&<Btn v="danger" onClick={()=>setBanks(banks.slice(0,-1))} style={{padding:"2px 6px",fontSize:"9px"}}>Remove</Btn>}
                  </div>
                </div>
                {banks.map((b,i)=><BankSec key={i} idx={i} data={b} onChange={d=>{const n=[...banks];n[i]=d;setBanks(n)}}/>)}
                <OtherSec items={other} onChange={setOther}/>
                <Card>
                  <div style={sCss}>Income Summary</div>
                  <table style={{width:"100%",borderCollapse:"collapse",fontSize:"11px"}}><tbody>
                    {breakdown.map((b,i)=><tr key={i} style={{borderBottom:`1px solid ${B.teal600}`}}><td style={{padding:"5px 0",color:B.teal300}}>{b.label}</td><td style={{padding:"5px 0",textAlign:"right",fontFamily:fm,color:b.amount>0?B.white:B.gray400}}><Mon amount={b.amount}/></td></tr>)}
                    <tr style={{borderTop:`2px solid ${B.gold500}`}}><td style={{padding:"7px 0",fontWeight:800,color:B.white}}>Total Gross Annual</td><td style={{padding:"7px 0",textAlign:"right",fontFamily:fm,fontWeight:800,fontSize:"14px",color:B.gold400}}><Mon amount={total}/></td></tr>
                    <tr><td style={{padding:"3px 0",color:B.gray400,fontSize:"10px"}}>Monthly Gross</td><td style={{padding:"3px 0",textAlign:"right",fontFamily:fm,color:B.gray400,fontSize:"10px"}}><Mon amount={total/12}/></td></tr>
                  </tbody></table>
                </Card>
              </div>
            </div>

            {/* VERIFICATION DECISION */}
            {canRun&&pr&&(
              <Card style={{marginBottom:"12px"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div style={{...sCss,color:B.gold500,marginBottom:0,borderBottom:"none",paddingBottom:0}}>Verification Decision</div>
                  <div style={{display:"flex",gap:"6px",alignItems:"center"}}>
                    {submitSt==="success"&&<span style={{fontSize:"11px",color:B.ok,fontWeight:700}}>✓ Saved to SharePoint</span>}
                    {submitSt==="error"&&<span style={{fontSize:"11px",color:B.no,fontWeight:600}}>{submitErr}</span>}
                    {isApprover&&<Btn v="success" onClick={handleSubmit} disabled={submitSt==="submitting"} style={{padding:"7px 18px"}}>{submitSt==="submitting"?"Saving...":"Submit to Audit Log"}</Btn>}
                  </div>
                </div>
                <div style={{marginTop:"10px"}}>
                  {overrideStatus==="OVERRIDE_APPROVED"?
                    <ResultBadge result={pr.result} reason={pr.reason} variance={pr.variance} tier={ami} overrideStatus={overrideStatus} overrideBy={overrideBy} overrideNotes={overrideNotesDisplay}/>
                    :<ResultBadge result={pr.result} reason={pr.reason} variance={pr.variance} tier={ami}/>
                  }
                  {ar&&!overrideStatus&&<><div style={{fontSize:"10px",color:B.teal300,margin:"6px 0 3px",textTransform:"uppercase",letterSpacing:"0.5px",fontWeight:700}}>Alt AMI Review (80%)</div><ResultBadge result={ar.result} reason={ar.reason} variance={ar.variance} tier={0.8}/></>}
                  {pr.result==="DENIED"&&!ar&&ami===0.8&&!overrideStatus&&<div style={{background:B.noBg,border:`1px solid ${B.noBr}`,borderRadius:"5px",padding:"8px 12px",fontSize:"11px",color:B.no,fontWeight:700,marginTop:"4px"}}>Already at 80% AMI — no higher tier available.</div>}
                </div>
                <F label="Verification Notes (optional)" style={{marginTop:"10px"}}><I value={notes} onChange={setNotes} placeholder="Notes for audit record..."/></F>

                {/* ADMIN OVERRIDE SECTION */}
                {pr.result==="DENIED"&&isAdmin&&!overrideStatus&&(
                  <div style={{marginTop:"12px",borderTop:`1px solid ${B.teal600}`,paddingTop:"12px"}}>
                    {!showOverride?
                      <Btn v="override" onClick={()=>setShowOverride(true)} style={{fontSize:"12px",padding:"8px 16px"}}>⚖ Override Denial (Admin Only)</Btn>
                    :(
                      <div style={{background:B.ovBg,border:`1px solid ${B.ovBr}`,borderRadius:"6px",padding:"12px"}}>
                        <div style={{fontSize:"12px",fontWeight:700,color:B.ov,marginBottom:"8px"}}>⚖ Admin Override</div>
                        <div style={{fontSize:"11px",color:B.gray300,marginBottom:"8px"}}>This will override the denial and approve the applicant. Override reason is required and will appear on the printed decision letter.</div>
                        <F label="Override Reason / Notes (required)"><textarea value={ovrNotes} onChange={e=>setOvrNotes(e.target.value)} placeholder="Explain the reason for overriding this denial..." style={{...iCss,height:"60px",resize:"vertical"}}/></F>
                        <div style={{display:"flex",gap:"8px"}}>
                          <Btn v="override" onClick={handleOverride} disabled={ovrSaving||!ovrNotes.trim()} style={{padding:"8px 20px"}}>{ovrSaving?"Processing...":"Confirm Override"}</Btn>
                          <Btn v="secondary" onClick={()=>{setShowOverride(false);setOvrNotes("")}}>Cancel</Btn>
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </Card>
            )}
            {canRun&&pr&&<PrintResult fd={fd} pr={pr} ar={ar} total={total} breakdown={breakdown} reviewer={reviewer} limitsLabel={countyLimits?.label||""} overrideStatus={overrideStatus} overrideBy={overrideBy} overrideNotes={overrideNotesDisplay} vDate={vDate}/>}
          </>
        )}
        </>}
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(window.AMICalculator));
</script>
</body>
</html>
